<body>
  <h1>üéµ Music.santiagoac.com</h1>

  <div class="row">
    <label>Fuente:
      <select id="src">
        <option value="yt" selected>YouTube</option>
        <option value="sp">Spotify ‚Üí YT</option>
        <option value="dz">Deezer ‚Üí YT</option>
        <option value="sc">SoundCloud</option>
        <option value="bc">Bandcamp ‚Üí YT</option>
      </select>
    </label>
    <input id="q" placeholder="buscar..." value="bad guy" />
    <button id="btn">Buscar</button>
  </div>

  <div id="results" class="grid"></div>

  <h3>Reproductor</h3>
  <audio id="player" preload="none" controls style="width:100%;"></audio>
  <div class="row">
    <button id="btnStop">Stop</button>
    <button id="btnTest" class="muted" title="Abre la URL de audio en otra pesta√±a">Abrir URL directa</button>
  </div>
  <p class="muted" id="status">Listo</p>

  <h3>Logs</h3>
  <div id="log"></div>

<style>
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(240px,1fr));
    gap: 12px;
  }
  .card {
    background:#fff; border:1px solid #eee; border-radius:10px; padding:10px;
    display:flex; gap:10px;
  }
  .thumb { width:84px; height:84px; border-radius:8px; object-fit:cover; background:#ddd; }
  .meta { flex:1; min-width:0; }
  .title { font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .sub { color:#777; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .badg { font-size:11px; background:#f2f2f2; padding:2px 6px; border-radius:6px; display:inline-block; margin-top:4px;}
  .actions { display:flex; align-items:center; gap:8px; }
</style>

<script>
const qs   = (s) => document.querySelector(s);
const log  = (m) => { const el = qs('#log'); const t = `[${new Date().toLocaleTimeString()}] ${m}\n`; el.textContent += t; el.scrollTop = el.scrollHeight; };

const btn = qs('#btn');
const src = qs('#src');
const q   = qs('#q');
const results = qs('#results');
const audio = qs('#player');
const status = qs('#status');
const btnStop = qs('#btnStop');
const btnTest = qs('#btnTest');

let lastVid = null;
let lastUrl = null;

function setStatus(s){ status.textContent = s; log(s); }
function msToTime(ms){ if(!ms&&ms!==0) return ""; const t=Math.floor(ms/1000); const m=Math.floor(t/60); const s=t%60; return `${m}:${s.toString().padStart(2,'0')}`; }

function wireAudioEvents() {
  ['loadstart','durationchange','loadedmetadata','canplay','playing','pause','stalled','waiting','suspend','ended','seeking','seeked','timeupdate','error']
  .forEach(ev => audio.addEventListener(ev, () => log(`audio:${ev} t=${audio.currentTime.toFixed(2)}`)));
}
wireAudioEvents();

btnStop.onclick = () => { audio.pause(); audio.currentTime = 0; setStatus('Parado'); };
btnTest.onclick = () => { if (lastUrl) window.open(lastUrl, '_blank'); else if (lastVid) window.open(`/audio-proxy/${encodeURIComponent(lastVid)}`, '_blank'); };

btn.onclick = async () => {
  const s = src.value; const query = q.value.trim();
  if (!query) return;
  results.innerHTML = '';
  setStatus('Buscando‚Ä¶');

  try {
    const r = await fetch(`/api/search?source=${encodeURIComponent(s)}&q=${encodeURIComponent(query)}`);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();
    const arr = data.results || [];

    if (!arr.length) {
      results.innerHTML = '<div class="muted">Sin resultados</div>';
      setStatus('Sin resultados');
      return;
    }
    setStatus('Resultados listos');

    for (const row of arr) {
      const imgUrl = row.info?.artworkUrl || row.cover || '/static/no-cover.png';
      const title  = row.info?.title || row.display || '(sin t√≠tulo)';
      const author = row.info?.author || '';
      const len    = msToTime(row.info?.length);
      const badge  = row.info?.sourceName || 'desconocido';

      const card = document.createElement('div');
      card.className = 'card';

      const img = document.createElement('img');
      img.className = 'thumb';
      img.src = imgUrl;

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `
        <div class="title" title="${title}">${title}</div>
        <div class="sub" title="${author}">${author}</div>
        <div class="sub">${len ? '‚è± '+len : ''}</div>
        <div class="badg">${badge}</div>
      `;

      const actions = document.createElement('div');
      actions.className = 'actions';
      const btnPlay = document.createElement('button');
      btnPlay.textContent = '‚ñ∂ Play';

      // S√≥lo reproducimos si hay v√≠deo YT v√°lido (11 chars). Otros los dejamos deshabilitados por ahora.
      const vid = row.vid && row.vid.length === 11 ? row.vid : null;
      if (!vid) {
        btnPlay.disabled = true;
        btnPlay.title = 'No reproducible (playlist/canal o fuente sin vid YT directo)';
      } else {
        btnPlay.onclick = () => playVid(vid);
      }
      actions.appendChild(btnPlay);

      card.append(img, meta, actions);
      results.appendChild(card);
    }
  } catch (e) {
    setStatus('‚ùå Error buscando: ' + e.message);
  }
};

async function playVid(vid) {
  lastVid = vid;

  // helper que prepara <audio>, espera canplay (hasta 7s) y hace play()
  async function tryUrl(u) {
    // limpiar <audio> sin hacer pause() mientras un play() est√© en curso
    audio.removeAttribute('src');
    while (audio.firstChild) audio.removeChild(audio.firstChild);

    const s = document.createElement('source');
    s.src = u;
    audio.appendChild(s);
    audio.load();

    // esperamos canplay, pero no bloqueamos duro si no llega
    const canplay = new Promise(res => {
      const fn = () => { audio.removeEventListener('canplay', fn); res(); };
      audio.addEventListener('canplay', fn);
    });
    const to = new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout canplay')), 7000));
    try { await Promise.race([canplay, to]); } catch(_) {}

    // importante: NO llames a pause() alrededor de este play()
    await audio.play();
    lastUrl = u;
    return true;
  }

  // 1) Proxy directo
  const proxyUrl = `/audio-proxy/${encodeURIComponent(vid)}`;
  setStatus(`Resolviendo v√≠a proxy: ${proxyUrl}`);
  try {
    if (await tryUrl(proxyUrl)) { setStatus('‚ñ∂Ô∏è Reproduciendo (proxy directo)'); return; }
  } catch (e) {
    setStatus('proxy directo fall√≥: ' + (e?.message || e));
  }

  // 2) Fallback /audio (redirige a la fuente p√∫blica)
  const redirUrl = `/audio/${encodeURIComponent(vid)}`;
  setStatus(`Probando fallback /audio: ${redirUrl}`);
  try {
    if (await tryUrl(redirUrl)) { setStatus('‚ñ∂Ô∏è Reproduciendo (fallback /audio)'); return; }
  } catch (e) {
    setStatus('‚ùå ning√∫n m√©todo pudo reproducir: ' + (e?.message || e));
  }
}

// primera b√∫squeda autom√°tica
btn.click();
</script>
</body>
