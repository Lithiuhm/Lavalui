<body>
  <h1>üéµ Music.santiagoac.com</h1>

  <div class="row">
    <label>Fuente:
      <select id="src">
        <option value="yt" selected>YouTube</option>
        <option value="sp">Spotify ‚Üí YT</option>
        <option value="dz">Deezer ‚Üí YT</option>
        <option value="sc">SoundCloud</option>
        <option value="bc">Bandcamp ‚Üí YT</option>
      </select>
    </label>
    <input id="q" placeholder="buscar..." value="bad guy" />
    <button id="btn">Buscar</button>
  </div>

  <div id="results" class="grid"></div>

  <h3>Reproductor (preparaci√≥n local)</h3>
  <audio id="player" preload="metadata" controls style="width:100%;"></audio>
  <p class="muted" id="status">Listo</p>

  <h3>Logs</h3>
  <pre id="log" style="max-height:260px;overflow:auto;background:#111;color:#9f9;padding:8px;border-radius:6px;"></pre>

<style>
  :root { color-scheme: dark; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0b0b; color:#eee; margin:20px; }
  .row { display:flex; gap:10px; align-items:center; margin:8px 0; flex-wrap:wrap; }
  .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:12px; margin-top:10px; }
  .card { background:#151515; border:1px solid #2a2a2a; border-radius:12px; padding:10px; display:flex; gap:10px; }
  .thumb { width:84px; height:84px; border-radius:8px; object-fit:cover; background:#333; }
  .meta { flex:1; min-width:0; }
  .title { font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .sub { color:#aaa; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .badg { font-size:11px; background:#222; padding:2px 6px; border-radius:6px; display:inline-block; margin-top:4px; color:#ccc;}
  button { background:#1e88ff; color:white; border:0; padding:6px 10px; border-radius:8px; cursor:pointer; }
  button[disabled]{ opacity:.5; cursor:not-allowed; }
  input, select { background:#131313; color:#eee; border:1px solid #2a2a2a; padding:6px 8px; border-radius:8px; }
  .muted { color:#aaa; }
</style>

<script>
const qs  = (s) => document.querySelector(s);
const log = (m) => { const el = qs('#log'); const t = `[${new Date().toLocaleTimeString()}] ${m}\n`; el.textContent += t; el.scrollTop = el.scrollHeight; };
const setStatus = (s) => { qs('#status').textContent = s; log(s); };

const src = qs('#src');
const q   = qs('#q');
const btn = qs('#btn');
const results = qs('#results');
const audio = qs('#player');

function msToTime(ms){ if(!ms&&ms!==0) return ""; const t=Math.floor(ms/1000); const m=Math.floor(t/60); const s=t%60; return `${m}:${s.toString().padStart(2,'0')}`; }

btn.onclick = async () => {
  const s = src.value; const query = q.value.trim();
  if (!query) return;
  results.innerHTML = '';
  setStatus('Buscando‚Ä¶');

  try {
    const r = await fetch(`/api/search?source=${encodeURIComponent(s)}&q=${encodeURIComponent(query)}`);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();
    const arr = data.results || [];
    if (!arr.length) { results.innerHTML = '<div class="muted">Sin resultados</div>'; setStatus('Sin resultados'); return; }

    setStatus('Resultados listos');
    for (const row of arr.slice(0,10)) {
      const imgUrl = row.info?.artworkUrl || row.cover || '/static/no-cover.png';
      const title  = row.info?.title || row.display || '(sin t√≠tulo)';
      const author = row.info?.author || '';
      const len    = msToTime(row.info?.length);
      const badge  = row.info?.sourceName || 'desconocido';
      const vid    = row.vid && row.vid.length === 11 ? row.vid : null;

      const card = document.createElement('div'); card.className = 'card';
      const img = document.createElement('img'); img.className = 'thumb'; img.src = imgUrl; img.loading = 'lazy';
      const meta = document.createElement('div'); meta.className = 'meta';
      meta.innerHTML = `
        <div class="title" title="${title}">${title}</div>
        <div class="sub" title="${author}">${author}</div>
        <div class="sub">${len ? '‚è± '+len : ''}</div>
        <div class="badg">${badge}</div>
      `;
      const actions = document.createElement('div');
      const b = document.createElement('button'); b.textContent = 'Preparar y reproducir';
      if (!vid) { b.disabled = true; b.title = 'No se puede preparar (no es v√≠deo YT)'; }
      b.onclick = () => prepareAndPlay(vid, title);
      actions.appendChild(b);
      card.append(img, meta, actions);
      results.appendChild(card);
    }
  } catch (e) {
    setStatus('‚ùå Error buscando: ' + e.message);
  }
};

async function prepareAndPlay(vid, title) {
  setStatus(`Preparando ¬´${title}¬ª‚Ä¶`);
  log('Solicitando preparaci√≥n local‚Ä¶');
  try {
    const r = await fetch(`/api/prepare/${encodeURIComponent(vid)}`, { method: 'POST' });
    if (!r.ok) throw new Error(`prepare HTTP ${r.status}`);
    const { token } = await r.json();

    let tries = 0;
    while (true) {
      const s = await fetch(`/api/prepare/${token}`);
      if (!s.ok) throw new Error(`status HTTP ${s.status}`);
      const js = await s.json();
      if (js.status === 'ready') {
        setStatus('Listo. Reproduciendo‚Ä¶');
        const url = `/audio-local/${token}`;
        audio.removeAttribute('src'); while (audio.firstChild) audio.removeChild(audio.firstChild);
        const srcEl = document.createElement('source'); srcEl.src = url; srcEl.type = 'audio/mp4';
        audio.appendChild(srcEl);
        audio.load();
        await audio.play();
        setStatus('‚ñ∂Ô∏è Reproduciendo (desde cach√© local del servidor)');
        break;
      } else if (js.status === 'error') {
        throw new Error(js.msg || 'fallo preparando');
      } else {
        setStatus(`Estado: ${js.status}‚Ä¶`);
      }
      await new Promise(r => setTimeout(r, Math.min(2500 + tries*250, 5000)));
      tries++;
    }
  } catch (e) {
    setStatus('‚ùå Error preparando: ' + e.message);
  }
}

// primera b√∫squeda autom√°tica
btn.click();
</script>
</body>
